
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>catalyst.dl.runner.gan &#8212; Catalyst 20.01.2 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for catalyst.dl.runner.gan</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="p">(</span>  <span class="c1"># isort:skip</span>
    <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">catalyst.dl</span> <span class="k">import</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="nn">catalyst.utils.tools.typing</span> <span class="k">import</span> <span class="n">Device</span><span class="p">,</span> <span class="n">Model</span>


<div class="viewcode-block" id="MultiPhaseRunner"><a class="viewcode-back" href="../../../../api/dl.html#catalyst.dl.runner.gan.MultiPhaseRunner">[docs]</a><span class="k">class</span> <span class="nc">MultiPhaseRunner</span><span class="p">(</span><span class="n">Runner</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base Runner with multiple phases</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="MultiPhaseRunner.__init__"><a class="viewcode-back" href="../../../../api/dl.html#catalyst.dl.runner.gan.MultiPhaseRunner.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Model</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">input_batch_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">registered_phases</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            model: gan models</span>
<span class="sd">            device: runner&#39;s device</span>
<span class="sd">            input_batch_keys: list of strings of keys for batch elements,</span>
<span class="sd">                e.g. ``input_batch_keys = [&quot;features&quot;, &quot;targets&quot;]`` and your</span>
<span class="sd">                DataLoader returns 2 tensors (images and targets)</span>
<span class="sd">                when state.input will be</span>
<span class="sd">                ``{&quot;features&quot;: batch[0], &quot;targets&quot;: batch[1]}``</span>
<span class="sd">            registered_phases: Tuple of pairs</span>
<span class="sd">                (phase_name, phase_forward_function)</span>
<span class="sd">                phase_forward_function&#39;s may be also str, in that case Runner</span>
<span class="sd">                should have method with same name, which will be called</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_batch_keys</span> <span class="o">=</span> <span class="n">input_batch_keys</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">registered_phases</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_batch_forward_fn</span> <span class="ow">in</span> <span class="n">registered_phases</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">phase_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="n">f</span><span class="s2">&quot;phase &#39;</span><span class="si">{phase_name}</span><span class="s2">&#39; of type &#39;{type(phase_name)}&#39; &quot;</span>
                    <span class="n">f</span><span class="s2">&quot;not supported, must be str of None&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registered_phases</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;phase &#39;</span><span class="si">{phase_name}</span><span class="s2">&#39; already registered&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_batch_forward_fn</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_batch_forward_fn</span><span class="p">)</span>
                <span class="n">phase_batch_forward_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_batch_forward_fn</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">phase_batch_forward_fn</span><span class="p">,</span> <span class="n">Callable</span>
            <span class="p">),</span> <span class="s2">&quot;must be callable&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registered_phases</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_batch_forward_fn</span></div>

    <span class="k">def</span> <span class="nf">_batch2device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">device</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_batch_keys</span><span class="p">)</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_batch_keys</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_batch2device</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

<div class="viewcode-block" id="MultiPhaseRunner.forward"><a class="viewcode-back" href="../../../../api/dl.html#catalyst.dl.runner.gan.MultiPhaseRunner.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Forward call&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">phase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registered_phases</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Unknown phase: &#39;</span><span class="si">{self.state.phase}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">registered_phases</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">phase</span><span class="p">]()</span></div></div>


<div class="viewcode-block" id="GanRunner"><a class="viewcode-back" href="../../../../api/dl.html#catalyst.dl.runner.gan.GanRunner">[docs]</a><span class="k">class</span> <span class="nc">GanRunner</span><span class="p">(</span><span class="n">MultiPhaseRunner</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runner with logic for single-generator single-discriminator GAN training</span>

<span class="sd">    Various conditioning types, penalties and regularization (such as WGAN-GP)</span>
<span class="sd">    can be easily derived from this class</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="GanRunner.__init__"><a class="viewcode-back" href="../../../../api/dl.html#catalyst.dl.runner.gan.GanRunner.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Model</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">input_batch_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># input keys</span>
        <span class="n">data_input_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
        <span class="n">class_input_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;class_targets&quot;</span><span class="p">,</span>
        <span class="n">noise_input_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;noise&quot;</span><span class="p">,</span>
        <span class="c1"># output keys</span>
        <span class="n">fake_logits_output_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fake_logits&quot;</span><span class="p">,</span>
        <span class="n">real_logits_output_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;real_logits&quot;</span><span class="p">,</span>
        <span class="n">fake_data_output_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fake_data&quot;</span><span class="p">,</span>
        <span class="c1"># condition_keys</span>
        <span class="n">fake_condition_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">real_condition_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># phases:</span>
        <span class="n">generator_train_phase</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;generator_train&quot;</span><span class="p">,</span>
        <span class="n">discriminator_train_phase</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;discriminator_train&quot;</span><span class="p">,</span>
        <span class="c1"># model keys:</span>
        <span class="n">generator_model_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;generator&quot;</span><span class="p">,</span>
        <span class="n">discriminator_model_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;discriminator&quot;</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            model: Model</span>
<span class="sd">            device: Device</span>
<span class="sd">            input_batch_keys: list of strings of keys for batch elements,</span>
<span class="sd">                e.g. ``input_batch_keys = [&quot;features&quot;, &quot;targets&quot;]`` and</span>
<span class="sd">                your DataLoader returns 2 tensors (images and targets)</span>
<span class="sd">                when state.input will be</span>
<span class="sd">                ``{&quot;features&quot;: batch[0], &quot;targets&quot;: batch[1]}``</span>
<span class="sd">            data_input_key: real distribution to fit</span>
<span class="sd">            class_input_key: labels for real distribution</span>
<span class="sd">            noise_input_key: noise</span>
<span class="sd">            fake_logits_output_key:  prediction scores of discriminator for</span>
<span class="sd">                fake data</span>
<span class="sd">            real_logits_output_key: prediction scores of discriminator for</span>
<span class="sd">                real data</span>
<span class="sd">            fake_data_output_key: generated data</span>
<span class="sd">            fake_condition_keys: list of all conditional inputs of</span>
<span class="sd">                discriminator (fake data conditions)</span>
<span class="sd">                (appear in same order as in generator model forward() call)</span>
<span class="sd">            real_condition_keys: list of all conditional inputs of</span>
<span class="sd">                discriminator (real data conditions)</span>
<span class="sd">                (appear in same order as in generator model forward() call)</span>
<span class="sd">            generator_train_phase(str): name for generator training phase</span>
<span class="sd">            discriminator_train_phase(str): name for discriminator</span>
<span class="sd">                training phase</span>
<span class="sd">            generator_model_key: name for generator model, e.g. &quot;generator&quot;</span>
<span class="sd">            discriminator_model_key: name for discriminator model,</span>
<span class="sd">                e.g. &quot;discriminator&quot;</span>

<span class="sd">        Note:</span>
<span class="sd">            THIS RUNNER SUPPORTS ONLY EQUALLY CONDITIONED generator and</span>
<span class="sd">            discriminator (i.e. if generator is conditioned on 3 variables,</span>
<span class="sd">            discriminator must be conditioned on same 3 variables)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_batch_keys</span> <span class="o">=</span> <span class="n">input_batch_keys</span> <span class="ow">or</span> <span class="p">[</span><span class="n">data_input_key</span><span class="p">]</span>
        <span class="n">registered_phases</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">generator_train_phase</span><span class="p">,</span> <span class="s2">&quot;_generator_train_phase&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">discriminator_train_phase</span><span class="p">,</span> <span class="s2">&quot;_discriminator_train_phase&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;_discriminator_train_phase&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">input_batch_keys</span><span class="p">,</span> <span class="n">registered_phases</span><span class="p">)</span>

        <span class="c1"># input keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_input_key</span> <span class="o">=</span> <span class="n">data_input_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_input_key</span> <span class="o">=</span> <span class="n">class_input_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_input_key</span> <span class="o">=</span> <span class="n">noise_input_key</span>
        <span class="c1"># output keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fake_logits_output_key</span> <span class="o">=</span> <span class="n">fake_logits_output_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">real_logits_output_key</span> <span class="o">=</span> <span class="n">real_logits_output_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fake_data_output_key</span> <span class="o">=</span> <span class="n">fake_data_output_key</span>
        <span class="c1"># condition keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fake_condition_keys</span> <span class="o">=</span> <span class="n">fake_condition_keys</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">real_condition_keys</span> <span class="o">=</span> <span class="n">real_condition_keys</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="c1"># check that discriminator will have</span>
        <span class="c1"># same number of arguments for real/fake data</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fake_condition_keys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">real_condition_keys</span><span class="p">)</span>
        <span class="p">),</span> <span class="s2">&quot;Number of real/fake conditions should be the same&quot;</span>
        <span class="c1"># Note: this generator supports only</span>
        <span class="c1"># EQUALLY CONDITIONED generator (G) and discriminator (D)</span>
        <span class="c1"># below are some thoughts why:</span>
        <span class="c1">#</span>
        <span class="c1"># 1. G is more conditioned than D.</span>
        <span class="c1">#</span>
        <span class="c1"># it would be strange if G is conditioned on something</span>
        <span class="c1"># and D is NOT conditioned on same variable</span>
        <span class="c1"># which will most probably lead to interpreting that variable</span>
        <span class="c1"># as additional noise</span>
        <span class="c1">#</span>
        <span class="c1"># 2. D is more conditioned than G.</span>
        <span class="c1">#</span>
        <span class="c1"># imagine D to have additional condition &#39;cond_var&#39; which is not</span>
        <span class="c1"># condition of G. now you have:</span>
        <span class="c1">#   fake_data = G(z, *other_conditions)</span>
        <span class="c1">#   fake_score = D(fake_data, cond_var, *other_conditions)</span>
        <span class="c1"># in the above example fake_data and cond_var are ~independent?</span>
        <span class="c1"># if they are not independent (e.g. cond_var represents</span>
        <span class="c1"># class condition which is fixed to the single &quot;cat&quot; class,</span>
        <span class="c1"># which may be used for finetuning pretrained GAN for specific</span>
        <span class="c1"># class) such configuration may have some sense</span>
        <span class="c1"># so they case #2 may have some sense, however for simplicity</span>
        <span class="c1"># it is not implemented in this Runner</span>

        <span class="c1"># model keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator_key</span> <span class="o">=</span> <span class="n">generator_model_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discriminator_key</span> <span class="o">=</span> <span class="n">discriminator_model_key</span></div>

    <span class="k">def</span> <span class="nf">_prepare_for_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_prepare_for_stage</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">generator_key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">discriminator_key</span><span class="p">]</span>

    <span class="c1"># Common utility functions</span>

    <span class="k">def</span> <span class="nf">_get_noise_and_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns generator inputs&quot;&quot;&quot;</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_input_key</span><span class="p">]</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_condition_keys</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">z</span><span class="p">,</span> <span class="n">conditions</span>

    <span class="k">def</span> <span class="nf">_get_real_data_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns discriminator conditions (for real data)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_condition_keys</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_fake_data_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns discriminator conditions (for fake data)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_condition_keys</span><span class="p">]</span>

    <span class="c1"># concrete phase methods</span>

    <span class="k">def</span> <span class="nf">_generator_train_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Forward call on generator training phase&quot;&quot;&quot;</span>
        <span class="n">z</span><span class="p">,</span> <span class="n">g_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_noise_and_conditions</span><span class="p">()</span>
        <span class="n">d_fake_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fake_data_conditions</span><span class="p">()</span>

        <span class="n">fake_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="o">*</span><span class="n">g_conditions</span><span class="p">)</span>
        <span class="n">fake_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">fake_data</span><span class="p">,</span> <span class="o">*</span><span class="n">d_fake_conditions</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fake_data_output_key</span><span class="p">:</span> <span class="n">fake_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fake_logits_output_key</span><span class="p">:</span> <span class="n">fake_logits</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_discriminator_train_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Forward call on discriminator training phase&quot;&quot;&quot;</span>
        <span class="n">z</span><span class="p">,</span> <span class="n">g_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_noise_and_conditions</span><span class="p">()</span>
        <span class="n">d_fake_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fake_data_conditions</span><span class="p">()</span>
        <span class="n">d_real_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_real_data_conditions</span><span class="p">()</span>

        <span class="n">fake_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="o">*</span><span class="n">g_conditions</span><span class="p">)</span>
        <span class="n">fake_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span>
            <span class="n">fake_data</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="o">*</span><span class="n">d_fake_conditions</span>
        <span class="p">)</span>
        <span class="n">real_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_input_key</span><span class="p">],</span> <span class="o">*</span><span class="n">d_real_conditions</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fake_data_output_key</span><span class="p">:</span> <span class="n">fake_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fake_logits_output_key</span><span class="p">:</span> <span class="n">fake_logits</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">real_logits_output_key</span><span class="p">:</span> <span class="n">real_logits</span>
        <span class="p">}</span></div>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MultiPhaseRunner&quot;</span><span class="p">,</span> <span class="s2">&quot;GanRunner&quot;</span><span class="p">]</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">Catalyst</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Catalyst</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../info/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../info/contributing.html">Contribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../info/license.html">Apache License</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/core.html">Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/dl.html">DL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/rl.html">RL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/contrib.html">Contrib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/utils.html">Utils</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Scitator.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>