model_params:
  _target_:  smp.Unet
  encoder_name/key: resnext50_32x4d
  classes: 1

runner_params:
  input_key: image
  input_target_key: mask

args:
  expdir: "_tests_cv_segmentation"
  logdir: "./logs/_tests_cv_segmentation"
  seed: &seed 42

stages:

  data_params:
    batch_size: 8
    num_workers: 0
    image_path: ./_tests_cv_segmentation/data/segmentation_data/train
    mask_path: ./_tests_cv_segmentation/data/segmentation_data/train_masks
    valid_size: 0.2

  stage_params:
    main_metric: iou
    minimize_metric: False

  criterion_params:
    _key_value: True

    dice:
      _target_:  DiceLoss
    iou:
      _target_:  IoULoss
    bce:
      _target_:  BCEWithLogitsLoss

  optimizer_params:
    _target_:  Adam
    layerwise_params:
      "encoder*":
        lr: 0.0005
        weight_decay: 0.00003
    lr: 0.001
    weight_decay: 0.0003
    no_bias_weight_decay: True

  stage1:
    stage_params:
      num_epochs: 3

    callbacks_params:
      train_augmentations:
        _wrapper:
          _target_:  ControlFlowCallback
          loaders: train
        _target_:  BatchTransformCallback
        transform:
          - _target_:  kornia.RandomErasing
            p: 0.2
        input_key: image
      loss_dice:
        _target_:  CriterionCallback
        input_key: mask
        prefix: loss_dice
        criterion_key: dice
      loss_iou:
        _target_:  CriterionCallback
        input_key: mask
        prefix: loss_iou
        criterion_key: iou
      loss_bce:
        _target_:  CriterionCallback
        input_key: mask
        prefix: loss_bce
        criterion_key: bce
      loss_aggregator:
        _target_:  MetricAggregationCallback
        prefix: loss
        mode: weighted_sum
        metrics: {"loss_dice": 1.0, "loss_iou": 1.0, "loss_bce": 0.8}

      dice:
        _target_:  DiceCallback
        input_key: mask
      iou:
        _target_:  IouCallback
        input_key: mask

      saver:
        _target_:  CheckpointCallback
